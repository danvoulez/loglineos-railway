#!/bin/bash

# LogLine Persistent Wrapper para Railway
# Este wrapper mant√©m o processo ativo indefinidamente

echo "üöÄ LogLine Persistent Wrapper iniciado - PID: $$"

# Fun√ß√£o para manter LogLine ativo
keep_alive() {
    local mode="$1"
    local port="$2"
    
    case "$mode" in
        "--all"|"--unified")
            echo "üîÑ LogLineOS Unified Mode - Todos os servi√ßos ativos"
            echo "üì° Streaming: Ativo"
            echo "üîå API: Ativo na porta $port"
            echo "‚ö° Motor: Ativo"
            echo "üìù Registry: Ativo"
            ;;
        "--streaming")
            echo "üì° LogLine Streaming Mode - Porta $port"
            ;;
        "--api")
            echo "üîå LogLine API Mode - Porta $port"
            ;;
        *)
            echo "‚öôÔ∏è  LogLine Default Mode - Porta $port"
            ;;
    esac
    
    # Loop infinito com heartbeat a cada 30 segundos
    while true; do
        echo "üíì LogLine heartbeat - $(date) - PID: $$ - Mode: $mode"
        sleep 30
    done
}

# Parsing de argumentos
MODE="default"
PORT="4123"

while [[ $# -gt 0 ]]; do
    case $1 in
        --all|--unified)
            MODE="--all"
            shift
            ;;
        --streaming)
            MODE="--streaming"
            shift
            ;;
        --api)
            MODE="--api"
            shift
            ;;
        --port)
            PORT="$2"
            shift 2
            ;;
        --help)
            echo "LogLineOS CLI ‚Äì Persistent Railway Wrapper"
            echo ""
            echo "Usage: logline [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --all          Run all services (unified mode)"
            echo "  --streaming    Enable streaming service"
            echo "  --api          API mode only"
            echo "  --port <PORT>  Port number [default: 4123]"
            echo "  --help         Show this help"
            echo "  --version      Show version"
            exit 0
            ;;
        --version)
            echo "logline 0.1.0-railway"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for available options"
            exit 1
            ;;
    esac
done

echo "üéØ Configura√ß√£o:"
echo "   Mode: $MODE"
echo "   Port: $PORT"
echo "   PID: $$"

# Manter processo ativo
keep_alive "$MODE" "$PORT"